This implementation avoids all vmaps in favor of loops
